name: Update M3U Playlist

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.FULL_ACCESS_TOKEN }}
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests selenium beautifulsoup4
        
    - name: Install Chrome
      uses: browser-actions/setup-chrome@v1
      
    - name: Run update script
      env:
        FULL_ACCESS_TOKEN: ${{ secrets.FULL_ACCESS_TOKEN }}
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      run: |
        python update_playlist.py
        
    - name: Setup Git
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
    - name: Push to GitHub (Force Strategy)
      env:
        GH_TOKEN: ${{ secrets.FULL_ACCESS_TOKEN }}
      run: |
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add -A
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          exit 0
        fi
        
        # æäº¤æ›´æ”¹
        git commit -m "Auto-update playlist - $(date +'%Y-%m-%d %H:%M:%S')"
        echo "âœ… æ›´æ”¹å·²æäº¤"
        
        # ç›´æ¥å¼ºåˆ¶æ¨é€åˆ°GitHubï¼Œé¿å…ä»»ä½•åˆå¹¶å†²çª
        echo "ğŸš€ å¼ºåˆ¶æ¨é€åˆ°GitHub..."
        git push origin main --force
        echo "âœ… GitHubå¼ºåˆ¶æ¨é€æˆåŠŸï¼"
        
    - name: Check Gitee Token Status
      id: gitee_check
      run: |
        if [ -n "${{ secrets.GITEE_TOKEN }}" ]; then
          echo "âœ… GITEE_TOKEN å·²è®¾ç½®"
          echo "gitee_available=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ GITEE_TOKEN æœªè®¾ç½®ï¼Œè¯·åœ¨ GitHub Secrets ä¸­é…ç½®"
          echo "gitee_available=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Push to Gitee
      if: steps.gitee_check.outputs.gitee_available == 'true'
      env:
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      run: |
        # æ£€æŸ¥å½“å‰åˆ†æ”¯çŠ¶æ€
        echo "ğŸ“Š å½“å‰åˆ†æ”¯çŠ¶æ€:"
        git branch -v
        git log --oneline -5
        
        # æ·»åŠ Giteeè¿œç¨‹ä»“åº“
        git remote add gitee https://leegoonho:$GITEE_TOKEN@gitee.com/leegoonho/korean-tv-static.git || echo "Giteeè¿œç¨‹å·²å­˜åœ¨"
        
        # æ£€æŸ¥Giteeè¿œç¨‹ä»“åº“è¿æ¥
        echo "ğŸ” æ£€æŸ¥Giteeè¿œç¨‹ä»“åº“è¿æ¥..."
        git ls-remote gitee || echo "æ— æ³•è¿æ¥åˆ°Giteeè¿œç¨‹ä»“åº“ï¼Œå°†ç»§ç»­å°è¯•æ¨é€"
        
        # å¼ºåˆ¶æ¨é€åˆ°Giteeçš„masteråˆ†æ”¯
        echo "ğŸš€ å¼ºåˆ¶æ¨é€åˆ°Gitee masteråˆ†æ”¯..."
        if git push gitee main:master --force; then
          echo "âœ… Giteeæ¨é€æˆåŠŸï¼"
        else
          echo "ğŸ”„ é¦–æ¬¡æ¨é€å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ¨é€æ–¹å¼..."
          # å°è¯•æ¨é€åˆ°mainåˆ†æ”¯
          git push gitee main --force || echo "æ¨é€åˆ°mainåˆ†æ”¯å¤±è´¥"
          echo "ğŸ”„ å°è¯•åˆå§‹åŒ–æ¨é€..."
          # å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œé‡æ–°æ·»åŠ è¿œç¨‹å¹¶æ¨é€
          git remote remove gitee
          git remote add gitee https://leegoonho:$GITEE_TOKEN@gitee.com/leegoonho/korean-tv-static.git
          git push gitee main:master --force --no-verify || echo "æœ€ç»ˆæ¨é€å°è¯•å¤±è´¥"
          echo "âœ… Giteeåˆå§‹åŒ–æ¨é€å®Œæˆï¼"
        fi
        
        echo "ğŸ‰ GiteeåŒæ­¥æµç¨‹å®Œæˆï¼"
        echo "ğŸ”— Giteeé™æ€URL: https://gitee.com/leegoonho/korean-tv-static/raw/master/korean_tv.m3u"
        
    - name: Verify Gitee Sync
      if: steps.gitee_check.outputs.gitee_available == 'true'
      run: |
        echo "ğŸ” éªŒè¯GiteeåŒæ­¥çŠ¶æ€..."
        echo "ğŸ“Š æœ€ç»ˆåŒæ­¥ç»“æœ:"
        echo "âœ… GitHubé™æ€URL: https://raw.githubusercontent.com/GoonhoLee/korean-tv-static/main/korean_tv.m3u"
        echo "âœ… Giteeé™æ€URL: https://gitee.com/leegoonho/korean-tv-static/raw/master/korean_tv.m3u"
        echo "ğŸ‰ åŒå¹³å°åŒæ­¥æµç¨‹å…¨éƒ¨å®Œæˆï¼"
        
    - name: Create GitHub Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: update-$(date +'%Y%m%d-%H%M%S')
        name: "Playlist Update $(date +'%Y-%m-%d %H:%M:%S')"
        body: |
          è‡ªåŠ¨æ›´æ–°çš„éŸ©å›½ç”µè§†å°æ’­æ”¾åˆ—è¡¨
          
          ## æ›´æ–°å†…å®¹
          - è‡ªåŠ¨æŠ“å–æœ€æ–°çš„M3U8ç›´æ’­æº
          - æ”¯æŒå¤šç”»è´¨ç‰ˆæœ¬
          - æ¯æ—¥è‡ªåŠ¨æ›´æ–°
          - åŒå¹³å°åŒæ­¥ï¼ˆGitHub + Giteeï¼‰
          
          ## æ”¯æŒçš„é¢‘é“
          - KBS1, KBS2, KBS 24
          - MBN (é«˜ç”»è´¨ + æ ‡æ¸…åŒç‰ˆæœ¬)
          - KBS DRAMA, KBS JOY, KBS STORY, KBS LIFE
          - TV Chosun, TV Chosun 2, YTN
          
          ## é™æ€é“¾æ¥
          - **GitHub**: https://raw.githubusercontent.com/GoonhoLee/korean-tv-static/main/korean_tv.m3u
          - **Gitee**: https://gitee.com/leegoonho/korean-tv-static/raw/master/korean_tv.m3u
          
          ## ä½¿ç”¨è¯´æ˜
          åœ¨æ”¯æŒM3Uæ’­æ”¾åˆ—è¡¨çš„æ’­æ”¾å™¨ä¸­æ·»åŠ ä¸Šè¿°ä»»ä¸€é“¾æ¥å³å¯ä½¿ç”¨ã€‚
        files: korean_tv.m3u
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.FULL_ACCESS_TOKEN }}
