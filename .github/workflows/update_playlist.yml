name: Update M3U Playlist

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.FULL_ACCESS_TOKEN }}
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests selenium beautifulsoup4
        
    - name: Install Chrome
      uses: browser-actions/setup-chrome@v1
      
    - name: Run update script
      env:
        FULL_ACCESS_TOKEN: ${{ secrets.FULL_ACCESS_TOKEN }}
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      run: |
        python update_playlist.py
        
    - name: Setup Git
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
    - name: Push to GitHub (No-Rebase Strategy)
      env:
        GH_TOKEN: ${{ secrets.FULL_ACCESS_TOKEN }}
      run: |
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add -A
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          exit 0
        fi
        
        # æäº¤æ›´æ”¹
        git commit -m "Auto-update playlist - $(date +'%Y-%m-%d %H:%M:%S')"
        echo "âœ… æ›´æ”¹å·²æäº¤"
        
        # å…ˆè·å–æœ€æ–°è¿œç¨‹æ›´æ”¹ï¼ˆä¸ä½¿ç”¨rebaseï¼‰
        echo "ğŸ”„ è·å–æœ€æ–°è¿œç¨‹æ›´æ”¹..."
        git fetch origin
        
        # é‡ç½®åˆ°è¿œç¨‹æœ€æ–°çŠ¶æ€ï¼Œä¿ç•™æˆ‘ä»¬çš„æ›´æ”¹
        echo "ğŸ”„ åˆå¹¶è¿œç¨‹æ›´æ”¹..."
        git merge origin/main --strategy-option theirs --no-edit || echo "åˆå¹¶å®Œæˆ"
        
        # å¦‚æœæœ‰å†²çªï¼Œä½¿ç”¨æˆ‘ä»¬çš„ç‰ˆæœ¬
        if git status | grep -q "both modified"; then
          echo "ğŸ”„ æ£€æµ‹åˆ°å†²çªï¼Œä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬..."
          git checkout --ours korean_tv.m3u
          git add korean_tv.m3u
          # é‡æ–°æäº¤
          git commit -m "Resolve merge conflict - use updated playlist"
        fi
        
        # æ¨é€æ›´æ”¹åˆ°GitHub
        echo "ğŸš€ æ¨é€åˆ°GitHub..."
        git push origin main
        echo "âœ… GitHubæ¨é€æˆåŠŸï¼"
        
    - name: Check Gitee Token Status
      id: gitee_check
      run: |
        if [ -n "${{ secrets.GITEE_TOKEN }}" ]; then
          echo "âœ… GITEE_TOKEN å·²è®¾ç½®"
          echo "gitee_available=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ GITEE_TOKEN æœªè®¾ç½®ï¼Œè¯·åœ¨ GitHub Secrets ä¸­é…ç½®"
          echo "gitee_available=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Push to Gitee
      if: steps.gitee_check.outputs.gitee_available == 'true'
      env:
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      run: |
        # æ£€æŸ¥å½“å‰åˆ†æ”¯çŠ¶æ€
        echo "ğŸ“Š å½“å‰åˆ†æ”¯çŠ¶æ€:"
        git branch -v
        git status
        
        # æ·»åŠ Giteeè¿œç¨‹ä»“åº“
        git remote add gitee https://leegoonho:$GITEE_TOKEN@gitee.com/leegoonho/korean-tv-static.git || echo "Giteeè¿œç¨‹å·²å­˜åœ¨"
        
        # æ£€æŸ¥Giteeè¿œç¨‹ä»“åº“è¿æ¥
        echo "ğŸ” æ£€æŸ¥Giteeè¿œç¨‹ä»“åº“..."
        git ls-remote gitee || echo "æ— æ³•è¿æ¥åˆ°Giteeè¿œç¨‹ä»“åº“"
        
        # å¼ºåˆ¶æ¨é€åˆ°Gitee
        echo "ğŸš€ æ¨é€åˆ°Gitee..."
        if git push gitee main --force; then
          echo "âœ… Giteeæ¨é€æˆåŠŸï¼"
        else
          echo "ğŸ”„ é¦–æ¬¡æ¨é€å¤±è´¥ï¼Œå°è¯•åˆå§‹åŒ–æ¨é€..."
          # å¦‚æœå¤±è´¥ï¼Œå¯èƒ½æ˜¯åˆ†æ”¯ä¸åŒ¹é…ï¼Œå°è¯•æ¨é€åˆ°masteråˆ†æ”¯
          git push gitee main:master --force || echo "Giteeæ¨é€å¤±è´¥"
          echo "âœ… Giteeåˆå§‹åŒ–æ¨é€å®Œæˆï¼"
        fi
        
        echo "ğŸ‰ åŒå¹³å°åŒæ­¥å®Œæˆï¼"
        echo "ğŸ”— GitHubé™æ€URL: https://raw.githubusercontent.com/GoonhoLee/korean-tv-static/main/korean_tv.m3u"
        echo "ğŸ”— Giteeé™æ€URL: https://gitee.com/leegoonho/korean-tv-static/raw/master/korean_tv.m3u"
        
    - name: Create Release with Updated Playlist
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: update-$(date +'%Y%m%d-%H%M%S')
        name: "Playlist Update $(date +'%Y-%m-%d %H:%M:%S')"
        body: |
          è‡ªåŠ¨æ›´æ–°çš„éŸ©å›½ç”µè§†å°æ’­æ”¾åˆ—è¡¨
          
          ## æ›´æ–°å†…å®¹
          - è‡ªåŠ¨æŠ“å–æœ€æ–°çš„M3U8ç›´æ’­æº
          - æ”¯æŒå¤šç”»è´¨ç‰ˆæœ¬
          - æ¯æ—¥è‡ªåŠ¨æ›´æ–°
          
          ## é™æ€é“¾æ¥
          - GitHub: https://raw.githubusercontent.com/GoonhoLee/korean-tv-static/main/korean_tv.m3u
          - Gitee: https://gitee.com/leegoonho/korean-tv-static/raw/master/korean_tv.m3u
        files: korean_tv.m3u
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.FULL_ACCESS_TOKEN }}
