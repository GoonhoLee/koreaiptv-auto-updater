name: Update M3U Playlist

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.FULL_ACCESS_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests selenium beautifulsoup4
        
    - name: Install Chrome
      uses: browser-actions/setup-chrome@v1
      
    - name: Run update script
      env:
        FULL_ACCESS_TOKEN: ${{ secrets.FULL_ACCESS_TOKEN }}
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      run: |
        python update_playlist.py
        
    - name: Setup Git
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
    - name: Push to GitHub (Force Update)
      env:
        GH_TOKEN: ${{ secrets.FULL_ACCESS_TOKEN }}
      run: |
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add -A
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          exit 0
        fi
        
        # æäº¤æ›´æ”¹
        git commit -m "Auto-update playlist - $(date +'%Y-%m-%d %H:%M:%S')"
        echo "âœ… æ›´æ”¹å·²æäº¤"
        
        # å¼ºåˆ¶æ¨é€åˆ°GitHubï¼ˆè¦†ç›–è¿œç¨‹ï¼‰
        echo "ğŸš€ å¼ºåˆ¶æ¨é€åˆ°GitHub..."
        git push origin main --force
        echo "âœ… GitHubå¼ºåˆ¶æ¨é€æˆåŠŸï¼"
        
    - name: Check Gitee Token
      id: check_gitee
      run: |
        if [ -n "${{ secrets.GITEE_TOKEN }}" ]; then
          echo "Gitee Token is available"
          echo "gitee_available=true" >> $GITHUB_OUTPUT
        else
          echo "Gitee Token is not available"
          echo "gitee_available=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Push to Gitee
      if: steps.check_gitee.outputs.gitee_available == 'true'
      env:
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      run: |
        # æ·»åŠ Giteeè¿œç¨‹ä»“åº“
        git remote add gitee https://leegoonho:$GITEE_TOKEN@gitee.com/leegoonho/korean-tv-static.git || echo "Giteeè¿œç¨‹å·²å­˜åœ¨"
        
        # å¼ºåˆ¶æ¨é€åˆ°Gitee
        echo "ğŸš€ æ¨é€åˆ°Gitee..."
        git push gitee main --force
        echo "âœ… Giteeæ¨é€æˆåŠŸï¼"
        
        echo "ğŸ‰ åŒå¹³å°åŒæ­¥å®Œæˆï¼"
        echo "ğŸ”— GitHubé™æ€URL: https://raw.githubusercontent.com/GoonhoLee/korean-tv-static/main/korean_tv.m3u"
        echo "ğŸ”— Giteeé™æ€URL: https://gitee.com/leegoonho/korean-tv-static/raw/master/korean_tv.m3u"
