name: Update M3U Playlist

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.FULL_ACCESS_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests selenium beautifulsoup4
        
    - name: Install Chrome
      uses: browser-actions/setup-chrome@v1
      
    - name: Run update script
      env:
        FULL_ACCESS_TOKEN: ${{ secrets.FULL_ACCESS_TOKEN }}
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      run: |
        python update_playlist.py
        
    - name: Initialize and Push to Gitee
      env:
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      run: |
        # è®¾ç½®Gitèº«ä»½
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        # æ·»åŠ Giteeè¿œç¨‹ä»“åº“
        git remote add gitee https://leegoonho:$GITEE_TOKEN@gitee.com/leegoonho/korean-tv-static.git
        
        # æ£€æŸ¥å½“å‰æ–‡ä»¶çŠ¶æ€
        echo "ğŸ“ å½“å‰æ–‡ä»¶çŠ¶æ€:"
        ls -la
        
        # ç¡®ä¿korean_tv.m3uæ–‡ä»¶å­˜åœ¨
        if [ ! -f "korean_tv.m3u" ]; then
          echo "âŒ korean_tv.m3uæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹æ–‡ä»¶"
          echo "#EXTM3U" > korean_tv.m3u
          echo "# ç¤ºä¾‹æ’­æ”¾åˆ—è¡¨" >> korean_tv.m3u
        fi
        
        # æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ°Git
        git add -A
        
        # æäº¤æ›´æ”¹
        if git diff --cached --quiet; then
          echo "âœ… æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        else
          git commit -m "Auto-update playlist - $(date +'%Y-%m-%d %H:%M:%S')"
          echo "âœ… æ›´æ”¹å·²æäº¤"
        fi
        
        # æ¨é€åˆ°Giteeï¼ˆå¤„ç†ç©ºä»“åº“çš„æƒ…å†µï¼‰
        echo "ğŸš€ æ¨é€åˆ°Gitee..."
        if git push gitee main; then
          echo "âœ… Giteeæ¨é€æˆåŠŸï¼"
        else
          echo "ğŸ”„ é¦–æ¬¡æ¨é€å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ¨é€åˆå§‹åŒ–..."
          git push --force gitee main
          echo "âœ… Giteeå¼ºåˆ¶æ¨é€æˆåŠŸï¼"
        fi
        
        echo "ğŸ‰ GiteeåŒæ­¥å®Œæˆï¼"
        echo "ğŸ”— Giteeé™æ€URL: https://gitee.com/leegoonho/korean-tv-static/raw/main/korean_tv.m3u"
