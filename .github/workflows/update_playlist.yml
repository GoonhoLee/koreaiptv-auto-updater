name: Update M3U Playlist

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.FULL_ACCESS_TOKEN }}
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests selenium beautifulsoup4
        
    - name: Install Chrome
      uses: browser-actions/setup-chrome@v1
      
    - name: Run update script
      env:
        FULL_ACCESS_TOKEN: ${{ secrets.FULL_ACCESS_TOKEN }}
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      run: |
        python update_playlist.py
        
    - name: Setup Git
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
    - name: Push to GitHub
      env:
        GH_TOKEN: ${{ secrets.FULL_ACCESS_TOKEN }}
      run: |
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add -A
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          # æäº¤æ›´æ”¹
          git commit -m "Auto-update playlist - $(date +'%Y-%m-%d %H:%M:%S')"
          echo "âœ… æ›´æ”¹å·²æäº¤åˆ°æœ¬åœ°"
          
          # å…ˆæ‹‰å–è¿œç¨‹æ›´æ”¹ï¼ˆä½¿ç”¨mergeç­–ç•¥ï¼‰
          echo "æ‹‰å–è¿œç¨‹æ›´æ”¹..."
          git fetch origin
          git merge origin/main --no-edit -X theirs || echo "åˆå¹¶å®Œæˆæˆ–æœ‰å†²çª"
          
          # å¦‚æœæœ‰å†²çªï¼Œå¼ºåˆ¶ä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬
          if git status | grep -q "both modified"; then
            echo "ğŸ”„ æ£€æµ‹åˆ°å†²çªï¼Œä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬..."
            git checkout --ours korean_tv.m3u
            git add korean_tv.m3u
          fi
          
          # å†æ¬¡æäº¤ï¼ˆå¦‚æœéœ€è¦ï¼‰
          if ! git diff --staged --quiet; then
            git commit -m "Resolve conflicts - use updated playlist"
          fi
          
          # æ¨é€æ›´æ”¹åˆ°GitHub
          echo "æ¨é€æ›´æ”¹åˆ°GitHub..."
          git push origin main
          echo "âœ… GitHubæ¨é€æˆåŠŸï¼"
        fi
        
    - name: Push to Gitee
      env:
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      run: |
        # æ·»åŠ Giteeè¿œç¨‹ä»“åº“
        git remote add gitee https://leegoonho:$GITEE_TOKEN@gitee.com/leegoonho/korean-tv-static.git || echo "Giteeè¿œç¨‹å·²å­˜åœ¨"
        
        # æ£€æŸ¥å½“å‰æ–‡ä»¶çŠ¶æ€
        echo "ğŸ“ å½“å‰æ–‡ä»¶çŠ¶æ€:"
        ls -la korean_tv.m3u || echo "korean_tv.m3uæ–‡ä»¶ä¸å­˜åœ¨"
        
        # ç¡®ä¿korean_tv.m3uæ–‡ä»¶å­˜åœ¨
        if [ ! -f "korean_tv.m3u" ]; then
          echo "âŒ korean_tv.m3uæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹æ–‡ä»¶"
          echo "#EXTM3U" > korean_tv.m3u
          echo "# ç¤ºä¾‹æ’­æ”¾åˆ—è¡¨" >> korean_tv.m3u
          git add korean_tv.m3u
          git commit -m "Create initial playlist file"
        fi
        
        # æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ°Gitï¼ˆç¡®ä¿æœ€æ–°æ›´æ”¹ï¼‰
        git add -A
        if ! git diff --staged --quiet; then
          git commit -m "Auto-update playlist - $(date +'%Y-%m-%d %H:%M:%S')" || echo "æ²¡æœ‰æ–°æ›´æ”¹"
        fi
        
        # æ¨é€åˆ°Gitee
        echo "ğŸš€ æ¨é€åˆ°Gitee..."
        if git push gitee main; then
          echo "âœ… Giteeæ¨é€æˆåŠŸï¼"
        else
          echo "ğŸ”„ é¦–æ¬¡æ¨é€å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ¨é€..."
          git push --force gitee main
          echo "âœ… Giteeå¼ºåˆ¶æ¨é€æˆåŠŸï¼"
        fi
        
        echo "ğŸ‰ åŒå¹³å°åŒæ­¥å®Œæˆï¼"
        echo "ğŸ”— GitHubé™æ€URL: https://raw.githubusercontent.com/GoonhoLee/korean-tv-static/main/korean_tv.m3u"
        echo "ğŸ”— Giteeé™æ€URL: https://gitee.com/leegoonho/korean-tv-static/raw/main/korean_tv.m3u"
        
    - name: Create Release with Playlist
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: update-$(date +'%Y%m%d-%H%M%S')
        name: "Playlist Update $(date +'%Y-%m-%d %H:%M:%S')"
        body: |
          è‡ªåŠ¨æ›´æ–°çš„éŸ©å›½ç”µè§†å°æ’­æ”¾åˆ—è¡¨
          
          ## é™æ€é“¾æ¥
          - GitHub: https://raw.githubusercontent.com/GoonhoLee/korean-tv-static/main/korean_tv.m3u
          - Gitee: https://gitee.com/leegoonho/korean-tv-static/raw/main/korean_tv.m3u
          
          ## æ›´æ–°å†…å®¹
          è‡ªåŠ¨æŠ“å–æœ€æ–°çš„M3U8ç›´æ’­æº
        files: korean_tv.m3u
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.FULL_ACCESS_TOKEN }}
